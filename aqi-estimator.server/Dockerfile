# Use Maven with Amazon Corretto 17 for building the app
FROM maven:3-amazoncorretto-21 AS build

# Set the working directory inside the container
WORKDIR /app

# Copy the pom.xml and the source code into the container
COPY . .

# Perform Maven clean install (skip tests)
RUN mvn clean install -DskipTests

# Now use a slim JDK image to run the app
FROM amazoncorretto:21

# Install binutils package (which includes execstack)
# RUN apk update && apk install -y binutils

# Set the working directory inside the container
WORKDIR /app

# Copy the JAR file generated by Maven from the build stage into the container
COPY --from=build /app/target/aqi-estimator-server-0.0.1-SNAPSHOT.jar /app/

# Copy native libraries (if any) to the correct location
COPY --from=build /app/src/main/resources/native/ /app/src/main/resources/native/

# Modify the ELF header of the native library (optional, for stack guard issues)
# RUN execstack -c /app/src/main/resources/native/libImagePipeline.so

# Expose the port the Spring Boot app runs on
EXPOSE 8080

# Run the Spring Boot application with the correct path for native libraries
CMD ["java", "-Djava.library.path=src/main/resources/native", "-jar", "aqi-estimator-server-0.0.1-SNAPSHOT.jar"]